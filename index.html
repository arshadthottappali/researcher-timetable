<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Timetable">
<meta name="theme-color" content="#d4a853" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#b8862a" media="(prefers-color-scheme: light)">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>The Researcher's Timetable</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/*  TOKENS  */
[data-theme="dark"] {
  --bg:#0f1117; --surf:#181b24; --surf2:#1e2130;
  --b:#272c3d; --b2:#313650;
  --txt:#eae6df; --txt2:#8b91a8; --txt3:#555d78;
  --gold:#d4a853; --gold-d:rgba(212,168,83,.13); --gold-g:rgba(212,168,83,.28);
  --teal:#5bb8c4; --teal-d:rgba(91,184,196,.13);
  --red:#c46b6b; --red-d:rgba(196,107,107,.13);
  --green:#5aab5a; --green-d:rgba(90,171,90,.13);
  --done-bg:#111a11; --done-b:#2f5c2f;
  --active-bg:#13192a;
  --nav-bg:#13161f;
  --sh:0 2px 12px rgba(0,0,0,.4);
  --sh2:0 6px 24px rgba(0,0,0,.5);
}
[data-theme="light"] {
  --bg:#f0ece3; --surf:#ffffff; --surf2:#f9f6f1;
  --b:#e4ddd0; --b2:#d5ccc0;
  --txt:#1a1714; --txt2:#6b5f52; --txt3:#a0948a;
  --gold:#b8862a; --gold-d:rgba(184,134,42,.1); --gold-g:rgba(184,134,42,.22);
  --teal:#2a8a96; --teal-d:rgba(42,138,150,.1);
  --red:#a84040; --red-d:rgba(168,64,64,.1);
  --green:#3a7a3a; --green-d:rgba(58,122,58,.1);
  --done-bg:#f0f7f0; --done-b:#5a9a5a;
  --active-bg:#eef3ff;
  --nav-bg:#ffffff;
  --sh:0 2px 12px rgba(0,0,0,.07);
  --sh2:0 6px 24px rgba(0,0,0,.12);
}

/*  RESET  */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;overflow:hidden;}
body{
  background:var(--bg); color:var(--txt);
  font-family:'DM Sans',sans-serif; font-size:14px; line-height:1.5;
  height:100%; overflow:hidden;
  display:flex; flex-direction:column;
  transition:background .3s,color .3s;
}

/*  INSTALL BANNER  */
#install-banner{
  display:none; align-items:center; justify-content:space-between;
  gap:10px; padding:10px 16px;
  background:var(--gold); color:#1a1200;
  font-size:12px; font-weight:600;
  flex-shrink:0;
}
#install-banner.show{display:flex;}
#install-banner button{
  padding:5px 14px; border-radius:20px;
  border:2px solid rgba(0,0,0,.25);
  background:rgba(0,0,0,.15); color:#1a1200;
  font-family:'DM Sans',sans-serif; font-size:11px; font-weight:700;
  cursor:pointer; white-space:nowrap;
}
body.onboard-open{overflow:hidden;}

/*  ONBOARDING  */
#onboard{
  position:fixed;inset:0;z-index:300;
  display:none;align-items:center;justify-content:center;
  padding:14px;
  background:linear-gradient(180deg,rgba(6,9,16,.86),rgba(8,12,22,.96));
}
#onboard.show{display:flex;}
.onb-shell{
  width:min(940px,100%);max-height:92vh;overflow:auto;
  background:linear-gradient(180deg,var(--surf),var(--surf2));
  border:1.5px solid var(--b2);border-radius:18px;
  box-shadow:0 18px 48px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
  padding:18px;
}
.onb-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px;}
.onb-step{font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:var(--gold);font-weight:700;}
.onb-skip{border:none;background:transparent;color:var(--txt2);cursor:pointer;font-size:12px;}
.onb-title{font-family:'DM Serif Display',serif;font-size:28px;line-height:1.1;margin-bottom:8px;}
.onb-sub{color:var(--txt2);font-size:14px;margin-bottom:14px;max-width:70ch;}
.onb-hero{
  border:1.5px solid var(--gold);border-radius:14px;padding:14px;
  background:linear-gradient(140deg,var(--active-bg),var(--surf));
  box-shadow:0 0 0 3px var(--gold-d);
  margin-bottom:12px;
}
.onb-hero-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
.onb-kicker{font-size:10px;letter-spacing:.14em;text-transform:uppercase;color:var(--gold);font-weight:700;margin-bottom:4px;}
.onb-hero h3{font-family:'DM Serif Display',serif;font-size:24px;line-height:1.1;}
.onb-time{
  font-family:'DM Serif Display',serif;font-size:32px;line-height:1;
  color:var(--gold);white-space:nowrap;
}
.onb-progress{
  height:6px;border-radius:999px;background:var(--b2);
  margin-top:12px;overflow:hidden;
}
.onb-progress > span{
  display:block;height:100%;width:48%;
  background:linear-gradient(90deg,var(--gold),var(--teal));
}
.onb-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.onb-card{
  background:linear-gradient(180deg,var(--surf2),var(--surf));
  border:1px solid var(--b2);border-radius:12px;padding:12px;
}
.onb-card h4{font-size:13px;margin-bottom:6px;color:var(--txt);}
.onb-card p{font-size:12px;color:var(--txt2);}
.onb-shot{
  border:1px solid var(--b2);background:linear-gradient(150deg,var(--surf),var(--surf2));
  border-radius:10px;padding:10px;margin-top:8px;
}
.onb-shot-line{height:7px;background:var(--b2);border-radius:999px;margin:6px 0;}
.onb-shot-line.gold{background:linear-gradient(90deg,var(--gold),var(--teal));}
.onb-auth{max-width:430px;}
.onb-time-row{display:flex;gap:8px;margin-top:8px;}
.onb-time-row input[type="time"]{flex:1;}
.onb-foot{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:14px;}
.onb-dots{display:flex;gap:6px;}
.onb-dot{width:7px;height:7px;border-radius:50%;background:var(--b2);}
.onb-dot.on{background:var(--gold);}
.onb-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
.onb-only{display:none;}
#onboard[data-step="0"] .onb-step-0,
#onboard[data-step="1"] .onb-step-1,
#onboard[data-step="2"] .onb-step-2{display:block;}
@media(max-width:760px){
  .onb-title{font-size:24px;}
  .onb-grid{grid-template-columns:1fr;}
  .onb-hero h3{font-size:20px;}
  .onb-time{font-size:26px;}
}

/*  PAGES  */
#pages{flex:1;overflow:hidden;position:relative;}
.page{
  position:absolute; inset:0;
  overflow-y:auto; overflow-x:hidden;
  padding:16px 14px 100px;
  transform:translateX(100%);
  transition:transform .28s cubic-bezier(.4,0,.2,1);
  -webkit-overflow-scrolling:touch;
}
.page.active{transform:translateX(0);}
.page.left{transform:translateX(-100%);}

/*  BOTTOM NAV  */
#bottom-nav{
  flex-shrink:0;
  display:flex;
  background:var(--nav-bg);
  border-top:1px solid var(--b);
  padding-bottom:env(safe-area-inset-bottom,0px);
  box-shadow:0 -4px 20px rgba(0,0,0,.2);
  z-index:100;
}
.nav-btn{
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:3px; padding:10px 4px 8px;
  background:transparent; border:none;
  color:var(--txt3); cursor:pointer;
  transition:color .2s;
  -webkit-tap-highlight-color:transparent;
}
.nav-btn.active{color:var(--gold);}
.nav-icon{font-size:20px; line-height:1;}
.nav-label{font-size:9px; font-weight:600; letter-spacing:.05em; text-transform:uppercase;}
.nav-btn.active .nav-icon{
  filter:drop-shadow(0 0 6px var(--gold-g));
}

/*  SECTION LABEL  */
.eyebrow{font-size:10px;font-weight:600;letter-spacing:.18em;text-transform:uppercase;color:var(--gold);margin-bottom:4px;}
.page-title{font-family:'DM Serif Display',serif;font-size:clamp(20px,5vw,28px);line-height:1.1;margin-bottom:16px;}
.page-title em{font-style:italic;color:var(--gold);}

/*  HOME PAGE  */

/* Status bar */
.status-bar{
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:14px; gap:8px;
}
.date-time-block .date-str{font-size:11px;color:var(--txt3);}
.date-time-block .clock-str{font-size:22px;font-weight:500;color:var(--teal);letter-spacing:.04em;}
.theme-toggle{
  display:flex; background:var(--surf); border:1.5px solid var(--b);
  border-radius:50px; padding:3px; cursor:pointer; gap:1px;
}
.t-pill{
  width:28px;height:28px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:14px;border:none;background:transparent;cursor:pointer;
  transition:background .2s;
}
.t-pill.active{background:var(--gold-d);}

/* Active block hero card */
.hero-card{
  background:var(--surf); border:2px solid var(--gold);
  border-radius:18px; padding:16px;
  margin-bottom:12px;
  box-shadow:0 0 0 4px var(--gold-d), var(--sh2);
  animation:pulse-gold 3s ease-in-out infinite;
}
.hero-card.idle{border-color:var(--b);box-shadow:var(--sh);animation:none;}
@keyframes pulse-gold{
  0%,100%{box-shadow:0 0 0 3px var(--gold-d),var(--sh);}
  50%{box-shadow:0 0 0 7px var(--gold-g),var(--sh);}
}
.hero-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.hero-label{font-size:10px;font-weight:600;letter-spacing:.15em;text-transform:uppercase;color:var(--gold);}
.hero-label.idle-lbl{color:var(--txt3);}
.hero-time-left{
  font-family:'DM Serif Display',serif;
  font-size:28px;color:var(--gold);line-height:1;
}
.hero-time-left.idle-time{font-size:18px;color:var(--txt3);}
.hero-block-name{
  font-family:'DM Serif Display',serif;
  font-size:20px;line-height:1.2;color:var(--txt);
  display:flex;align-items:center;gap:8px;
  margin-bottom:4px;
}
.hero-focus{font-size:12px;color:var(--txt2);margin-bottom:12px;}
.hero-progress-row{display:flex;align-items:center;gap:10px;}
.hero-prog-track{flex:1;height:5px;background:var(--b);border-radius:5px;overflow:hidden;}
.hero-prog-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--teal));border-radius:5px;transition:width .5s;}
.hero-prog-pct{font-size:11px;font-weight:600;color:var(--gold);min-width:32px;text-align:right;}

/* Next block */
.next-card{
  background:var(--surf); border:1.5px solid var(--b);
  border-radius:14px; padding:12px 14px;
  margin-bottom:12px; box-shadow:var(--sh);
  display:flex;align-items:center;gap:12px;
}
.next-icon{font-size:22px;flex-shrink:0;}
.next-content{flex:1;min-width:0;}
.next-label{font-size:10px;color:var(--txt3);font-weight:600;letter-spacing:.1em;text-transform:uppercase;}
.next-name{font-family:'DM Serif Display',serif;font-size:16px;color:var(--txt);margin-top:1px;}
.next-time{
  font-size:11px;color:var(--teal);margin-top:1px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.next-time .nt-end{text-align:right;margin-left:auto;}

/* Streak mini */
.streak-row{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  gap:8px;margin-bottom:12px;
}
.mini-stat{
  background:var(--surf);border:1.5px solid var(--b);
  border-radius:12px;padding:10px 8px;text-align:center;
  box-shadow:var(--sh);
}
.mini-stat-val{font-family:'DM Serif Display',serif;font-size:22px;color:var(--gold);line-height:1;}
.mini-stat-lbl{font-size:9px;color:var(--txt3);text-transform:uppercase;letter-spacing:.1em;margin-top:2px;}

/* Streak dots */
.dots-row{
  background:var(--surf);border:1.5px solid var(--b);
  border-radius:12px;padding:10px 14px;
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:12px;box-shadow:var(--sh);
}
.dots-label{font-size:10px;color:var(--txt3);font-weight:600;letter-spacing:.1em;text-transform:uppercase;}
.dots-wrap{display:flex;gap:5px;}
.sdot{width:9px;height:9px;border-radius:50%;background:var(--b2);transition:background .3s;}
.sdot.lit{background:var(--gold);box-shadow:0 0 6px var(--gold-g);}
.home-insights{
  background:var(--surf);border:1.5px solid var(--b);
  border-radius:14px;padding:12px;box-shadow:var(--sh);
}
.ins-head{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;}
.ins-remain{
  width:100%;margin-top:4px;
  background:var(--surf2);border:1px solid var(--b2);border-radius:10px;padding:8px 9px;
}
.ins-remain-top{display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:11px;color:var(--txt2);}
.ins-remain-track{height:6px;border-radius:999px;background:var(--b2);margin-top:7px;overflow:hidden;}
.ins-remain-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--gold),var(--teal));}
.ins-remain-now{margin-top:6px;font-size:12px;color:var(--txt);}
.ins-tabs{display:flex;gap:6px;}
.ins-tab{
  border:1.5px solid var(--b2);background:var(--surf2);color:var(--txt2);
  border-radius:999px;padding:5px 10px;font-size:11px;font-weight:700;cursor:pointer;
}
.ins-tab.active{border-color:var(--gold);color:var(--gold);background:var(--gold-d);}
.ins-graph{
  margin-top:10px;min-height:138px;border:1px solid var(--b2);border-radius:10px;
  background:linear-gradient(180deg,var(--surf2),var(--surf));padding:10px 10px 8px;
}
.ins-bars{
  height:98px;display:grid;gap:7px;align-items:end;
}
.ins-bars.week{grid-template-columns:repeat(7,1fr);}
.ins-bars.month{grid-template-columns:repeat(10,1fr);}
.ins-col{
  min-width:0;display:flex;flex-direction:column;align-items:center;gap:5px;
}
.ins-val{font-size:9px;color:var(--txt3);line-height:1;}
.ins-track{
  width:100%;max-width:16px;height:76px;border-radius:999px;
  background:var(--b2);position:relative;overflow:hidden;
}
.ins-fill{
  position:absolute;left:0;right:0;bottom:0;min-height:4px;border-radius:999px;
  background:linear-gradient(180deg,var(--gold),var(--teal));
}
.ins-fill.last{background:linear-gradient(180deg,var(--gold),#f2c46a);}
.ins-col.today .ins-track{
  border:1.5px solid var(--gold);
  box-shadow:0 0 0 3px var(--gold-d), 0 0 12px rgba(212,168,83,.45);
}
.ins-col.today .ins-val{color:var(--gold);}
.ins-col.today .ins-lbl{color:var(--gold);}
.ins-today-tag{
  margin-top:2px;font-size:8px;line-height:1;color:#1a1200;
  letter-spacing:.08em;text-transform:uppercase;font-weight:700;
  background:var(--gold);border-radius:999px;padding:2px 5px;min-height:12px;
}
.ins-lbl{font-size:9px;color:var(--txt3);line-height:1;}
.ins-bars.month .ins-lbl{font-size:8px;line-height:1.05;white-space:normal;text-align:center;}
.ins-meta{
  margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;
}
.ins-chip{
  background:var(--surf2);border:1px solid var(--b2);border-radius:10px;padding:8px 9px;
}
.ins-chip b{display:block;font-size:10px;color:var(--txt3);font-weight:700;letter-spacing:.05em;text-transform:uppercase;}
.ins-chip span{display:block;margin-top:3px;font-size:12px;color:var(--txt);}
@media(max-width:540px){
  .ins-meta{grid-template-columns:1fr;}
}
.home-insights .actions-row{margin-top:10px;}

/*  SCHEDULE PAGE  */
.toolbar{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;gap:8px;
  position:sticky; top:0; z-index:12;
  background:var(--bg);
  padding:8px 0 6px;
  backdrop-filter:saturate(120%) blur(6px);
}
.toolbar-label{font-size:10px;font-weight:600;letter-spacing:.15em;text-transform:uppercase;color:var(--txt3);}
.toolbar-actions{display:flex;gap:6px;}
.schedule-summary{
  margin:-2px 0 10px;
  background:var(--surf); border:1.5px solid var(--b);
  border-radius:10px; padding:8px 10px;
  font-size:11px; color:var(--txt2);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  box-shadow:var(--sh);
}

/* Buttons */
.btn-pill{
  height:34px; padding:0 14px; border-radius:50px;
  border:1.5px solid var(--b); background:var(--surf);
  color:var(--txt2); font-family:'DM Sans',sans-serif;
  font-size:12px;font-weight:500;
  display:inline-flex;align-items:center;gap:5px;
  cursor:pointer;transition:all .18s;
  box-shadow:var(--sh); white-space:nowrap;
}
.btn-pill:active{transform:scale(.95);}
.btn-pill.gold{border-color:var(--gold);color:var(--gold);background:var(--gold-d);}
.btn-pill.teal{border-color:var(--teal);color:var(--teal);background:var(--teal-d);}
.btn-pill.ghost{border-color:transparent;background:transparent;box-shadow:none;}
.btn-pill.danger{color:var(--red);border-color:var(--red-d);background:var(--red-d);}

/* Edit hint */
.edit-hint{font-size:11px;color:var(--txt3);text-align:center;margin:4px 0 8px;display:none;}
.edit-hint.on{display:block;}

/* Timeline */
.tl{display:flex;flex-direction:column;gap:6px;}

/* Slot */
.slot{
  background:var(--surf); border:1.5px solid var(--b);
  border-radius:14px; padding:12px 12px 12px 12px;
  display:grid; grid-template-columns:52px 1fr auto;
  align-items:start; gap:10px;
  position:relative; transition:all .2s;
  box-shadow:var(--sh);
}
.slot::after{
  content:''; position:absolute; left:0;top:8px;bottom:8px;
  width:3px;border-radius:0 3px 3px 0;
  background:var(--b);transition:background .2s;
}
.slot.done{background:var(--done-bg);border-color:var(--done-b);opacity:.72;}
.slot.done::after{background:var(--done-b);}
.slot.active-now{background:var(--active-bg);border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-d),var(--sh);}
.slot.active-now::after{background:var(--gold);}
.slot.dragging{opacity:.3;transform:scale(.96);}
.slot.drag-over{border-color:var(--teal);border-style:dashed;box-shadow:0 0 0 3px var(--teal-d);}

/* Edit mode slot */
.tl.edit-mode .slot{grid-template-columns:24px 112px 1fr auto;padding-left:8px;cursor:default;border-color:var(--b2);}
.tl.edit-mode .slot:hover{border-color:var(--teal);}
.tl.edit-mode .slot::after{display:none;}

/* Drag grip */
.drag-grip{
  display:none;flex-direction:column;align-items:center;
  justify-content:center;gap:3px;width:22px;
  cursor:grab;opacity:.4;transition:opacity .15s;
  align-self:center;flex-shrink:0;
}
.drag-grip:hover{opacity:1;}
.drag-grip:active{cursor:grabbing;}
.drag-grip span{display:flex;gap:3px;}
.drag-grip span::before,.drag-grip span::after{
  content:'';width:3px;height:3px;
  border-radius:50%;background:var(--txt2);
}
.tl.edit-mode .drag-grip{display:flex;}

/* Time col */
.tc{display:flex;flex-direction:column;gap:2px;padding-top:1px;}
.tc-icon{font-size:18px;margin-bottom:2px;}
.tc-time{font-size:9px;color:var(--txt3);line-height:1.5;}
.slot.active-now .tc-time{color:var(--gold);}
.slot.done .tc-time{color:var(--done-b);}
.time-inp-wrap{display:none;}
.tl.edit-mode .tc .tc-display{display:none;}
.tl.edit-mode .tc .time-inp-wrap{display:block;}
.time-edit-ico{font-size:14px;color:var(--txt2);margin-bottom:4px;}
.time-row{display:flex;align-items:center;gap:4px;}
.time-sep{font-size:10px;color:var(--txt3);}
.time-inp{
  background:var(--surf2);border:1.5px solid var(--b2);
  border-radius:6px;color:var(--txt);
  font-family:'DM Sans',sans-serif;font-size:11px;
  padding:5px 6px;width:48px;outline:none;
  transition:border-color .18s;
  text-align:center;
}
.time-inp:focus{border-color:var(--teal);}
.tl.edit-mode .slot-content .editable{
  background:var(--surf2);
  border:1px solid var(--b2);
  border-radius:7px;
  padding:6px 8px;
  margin-top:4px;
}
.tl.edit-mode .slot-content .act-inp{margin-top:0;}

/* Content */
.slot-content{min-width:0;}
.act-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.now-badge{
  font-size:9px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;
  background:var(--gold-d);border:1px solid var(--gold-g);
  border-radius:4px;padding:1px 5px;color:var(--gold);display:none;
}
.slot.active-now .now-badge{display:inline-block;}
.editable{
  background:transparent;border:none;
  border-bottom:1.5px solid transparent;
  color:inherit;font-family:inherit;font-size:inherit;font-weight:inherit;
  outline:none;width:100%;padding:1px 0;resize:none;
  transition:border-color .18s;cursor:default;
}
.tl.edit-mode .editable{border-bottom-color:var(--b2);cursor:text;}
.tl.edit-mode .editable:focus{border-bottom-color:var(--teal);}
.act-inp{font-family:'DM Serif Display',serif;font-size:15px;line-height:1.3;color:var(--txt);}
.slot.active-now .act-inp{color:var(--gold);}
.slot.done .act-inp{color:var(--done-b);text-decoration:line-through;}
.foc-inp{font-size:11px;color:var(--txt2);margin-top:2px;line-height:1.4;}
.slot.done .foc-inp{color:var(--txt3);}

/* Note */
.note-area{margin-top:8px;display:none;}
.note-area.open{display:block;}
.note-inp{
  width:100%;background:var(--surf2);
  border:1.5px solid var(--b);border-radius:8px;
  color:var(--txt);font-family:'DM Sans',sans-serif;
  font-size:12px;padding:8px 10px;resize:none;
  line-height:1.4;outline:none;transition:border-color .18s;
}
.note-inp:focus{border-color:var(--teal);}
.note-inp::placeholder{color:var(--txt3);}

/* Slot controls */
.slot-ctrl{display:flex;flex-direction:column;align-items:center;gap:6px;padding-top:2px;}
.chk-btn{
  width:30px;height:30px;border-radius:50%;
  border:2px solid var(--b2);background:transparent;
  color:transparent;font-size:13px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .18s;
}
.chk-btn:active{transform:scale(.88);}
.slot.done .chk-btn{background:var(--green);border-color:var(--green);color:#fff;}
.tl.edit-mode .chk-btn{display:none;}
.note-btn{
  width:26px;height:26px;border-radius:8px;
  border:1.5px solid var(--b);background:transparent;
  color:var(--txt3);font-size:12px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .18s;
}
.note-btn.has{border-color:var(--teal);color:var(--teal);background:var(--teal-d);}
.tl.edit-mode .note-btn{display:none;}
.del-btn{
  width:26px;height:26px;border-radius:8px;
  border:1.5px solid var(--b);background:transparent;
  color:var(--txt3);font-size:12px;
  display:none;align-items:center;justify-content:center;
  cursor:pointer;transition:all .18s;
}
.tl.edit-mode .del-btn{display:flex;}
.del-btn:active{background:var(--red-d);border-color:var(--red);color:var(--red);}

.add-inline{
  display:none;width:100%;margin-top:4px;
  padding:13px;background:transparent;
  border:2px dashed var(--b2);border-radius:14px;
  color:var(--txt3);font-family:'DM Sans',sans-serif;
  font-size:12px;font-weight:500;letter-spacing:.05em;
  cursor:pointer;transition:all .18s;text-align:center;
}
.add-inline:active{border-color:var(--teal);color:var(--teal);background:var(--teal-d);}

/* Actions row */
.actions-row{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;}
.actions-row .btn-pill{flex:1;min-width:90px;justify-content:center;height:40px;}

button:focus-visible,
textarea:focus-visible,
input:focus-visible{
  outline:2px solid var(--teal);
  outline-offset:2px;
}
.slot.reveal{animation:slot-in .24s cubic-bezier(.2,.8,.2,1) both;}
@keyframes slot-in{
  from{opacity:0;transform:translateY(8px);}
  to{opacity:1;transform:translateY(0);}
}
#toast{
  position:fixed; left:50%; bottom:78px; transform:translateX(-50%);
  background:var(--surf); color:var(--txt);
  border:1.5px solid var(--b2); border-radius:12px;
  padding:10px 14px; font-size:12px; font-weight:600;
  box-shadow:var(--sh2); z-index:999;
  opacity:0; pointer-events:none; transition:opacity .2s,transform .2s;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(-4px);}

/*  STATS PAGE  */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.stat-card{
  background:var(--surf);border:1.5px solid var(--b);
  border-radius:14px;padding:14px 12px;text-align:center;
  box-shadow:var(--sh);
}
.stat-card.wide{grid-column:span 2;}
.stat-v{font-family:'DM Serif Display',serif;font-size:30px;color:var(--gold);line-height:1;}
.stat-l{font-size:10px;color:var(--txt3);text-transform:uppercase;letter-spacing:.1em;margin-top:3px;}
.stat-sub{font-size:11px;color:var(--txt2);margin-top:4px;}

.history-list{display:flex;flex-direction:column;gap:6px;}
.history-row{
  background:var(--surf);border:1.5px solid var(--b);
  border-radius:10px;padding:10px 12px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:var(--sh);
}
.history-date{font-size:12px;color:var(--txt2);}
.history-bar-wrap{flex:1;margin:0 12px;height:5px;background:var(--b);border-radius:5px;overflow:hidden;}
.history-bar-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--teal));border-radius:5px;}
.history-pct{font-size:12px;font-weight:600;color:var(--gold);min-width:32px;text-align:right;}

/*  WIDGET INFO PAGE  */
.widget-card{
  background:var(--surf);border:1.5px solid var(--b);
  border-radius:16px;padding:16px;
  margin-bottom:12px;box-shadow:var(--sh);
}
.widget-card h3{font-family:'DM Serif Display',serif;font-size:18px;margin-bottom:8px;}
.widget-card p,.widget-card li{font-size:13px;color:var(--txt2);line-height:1.6;margin-bottom:6px;}
.widget-card ol{padding-left:18px;}
.widget-card li{margin-bottom:4px;}
.code-block{
  background:var(--surf2);border:1.5px solid var(--b2);
  border-radius:8px;padding:10px 12px;
  font-family:monospace;font-size:11px;
  color:var(--teal);word-break:break-all;
  margin:8px 0;line-height:1.6;
}
.copy-btn{
  width:100%;padding:10px;
  background:var(--gold-d);border:1.5px solid var(--gold);
  color:var(--gold);font-family:'DM Sans',sans-serif;
  font-size:12px;font-weight:600;letter-spacing:.05em;
  border-radius:8px;cursor:pointer;transition:all .18s;
}
.copy-btn:active{background:var(--gold);color:#1a1200;}
.name-row{margin-top:8px;}
.name-inp{
  width:100%;padding:10px 12px;border-radius:8px;
  border:1.5px solid var(--b2);background:var(--surf2);color:var(--txt);
  font:500 13px 'DM Sans',sans-serif;outline:none;
}
.name-inp:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-d);}
.name-btns{display:flex;gap:8px;margin-top:10px;}
.auth-grid{display:grid;gap:8px;margin-top:8px;}
.auth-help{font-size:12px;color:var(--txt2);}
.auth-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
.auth-row .btn-pill{font-size:11px;}
.sync-status{
  margin-top:8px;padding:8px 10px;border-radius:8px;
  border:1px solid var(--b2);background:var(--surf2);
  font-size:12px;color:var(--txt2);
}
.assist-list{margin:8px 0 0;padding-left:18px;}
.assist-list li{margin-bottom:4px;}
.assist-state{
  margin-top:8px;padding:8px 10px;border-radius:8px;
  border:1px dashed var(--b2);background:var(--surf2);font-size:12px;color:var(--txt2);
}
.conflict-box{
  margin-top:10px;padding:10px;border-radius:8px;
  border:1px solid var(--red);background:var(--red-d);
}
.conflict-title{font-size:12px;font-weight:700;color:var(--txt);margin-bottom:4px;}
.diag-list{display:grid;gap:6px;margin-top:8px;}
.diag-item{
  padding:8px 10px;border-radius:8px;border:1px solid var(--b2);
  background:var(--surf2);font-size:12px;color:var(--txt2);
}
.diag-item.ok{border-color:var(--green);background:var(--green-d);}
.diag-item.warn{border-color:var(--red);background:var(--red-d);}

/*  UTIL  */
@media(max-width:380px){
  .slot{grid-template-columns:46px 1fr auto;gap:8px;}
  .tl.edit-mode .slot{grid-template-columns:20px 96px 1fr auto;}
  .nav-label{font-size:8px;}
}
@media (prefers-reduced-motion: reduce){
  *{animation:none !important;transition:none !important;}
}
</style>
</head>
<body>

<!-- INSTALL BANNER -->
<div id="install-banner">
  <span id="installText">Add to Home Screen for the full app experience</span>
  <button onclick="installApp()">Install</button>
  <button onclick="document.getElementById('install-banner').classList.remove('show')" style="background:transparent;border:none;font-size:16px;padding:2px 6px;">X</button>
</div>

<!-- ONBOARDING -->
<div id="onboard" data-step="0" aria-modal="true" role="dialog">
  <div class="onb-shell">
    <div class="onb-head">
      <span class="onb-step" id="onbStepLabel">Step 1 of 3</span>
      <button class="onb-skip" onclick="startLocalMode()">Use Local Only</button>
    </div>

    <section class="onb-only onb-step-0">
      <h2 class="onb-title">Track your day in real time</h2>
      <p class="onb-sub">Researcher Timetable shows what you should do now, what is next, and how much progress you have made today.</p>
      <div class="onb-hero">
        <div class="onb-kicker">Now Active</div>
        <div class="onb-hero-top">
          <h3>Theoretical Study</h3>
          <div class="onb-time">47 min</div>
        </div>
        <p class="onb-sub" style="margin:6px 0 0;">LASER spectroscopy and singlet fission focus session.</p>
        <div class="onb-progress"><span></span></div>
      </div>
      <div class="onb-grid">
        <div class="onb-card">
          <h4>Live focus guidance</h4>
          <p>See your active block, remaining time, and next block instantly.</p>
          <div class="onb-shot">
            <div class="onb-shot-line gold" style="width:64%"></div>
            <div class="onb-shot-line" style="width:85%"></div>
            <div class="onb-shot-line" style="width:52%"></div>
          </div>
        </div>
        <div class="onb-card">
          <h4>Simple daily completion</h4>
          <p>Mark blocks done as you finish to keep accurate progress.</p>
          <div class="onb-shot">
            <div class="onb-shot-line" style="width:78%"></div>
            <div class="onb-shot-line gold" style="width:35%"></div>
            <div class="onb-shot-line" style="width:66%"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="onb-only onb-step-1">
      <h2 class="onb-title">Sign in to sync</h2>
      <p class="onb-sub">Login keeps your progress across devices. You can also continue local-only and sync later.</p>
      <div class="onb-auth">
        <input class="name-inp" id="onbEmail" type="email" placeholder="Email address" autocomplete="email">
        <input class="name-inp" id="onbPass" type="password" placeholder="Password (min 6 chars)" autocomplete="current-password" style="margin-top:8px;">
        <div class="auth-row">
          <button class="btn-pill" onclick="signIn('onbEmail','onbPass')">Sign In</button>
          <button class="btn-pill teal" onclick="signUp('onbEmail','onbPass')">Sign Up</button>
          <button class="btn-pill" onclick="startLocalMode()">Continue Local</button>
          <button class="btn-pill" onclick="sendReset('onbEmail')">Reset Password</button>
        </div>
      </div>
    </section>

    <section class="onb-only onb-step-2">
      <h2 class="onb-title">Set your first schedule block</h2>
      <p class="onb-sub">Use time pickers to create your first block. You can edit all blocks later in Schedule.</p>
      <div class="onb-auth">
        <input class="name-inp" id="onbTask" placeholder="First task (e.g., Deep Work)">
        <div class="onb-time-row">
          <input class="name-inp" id="onbStart" type="time" value="09:00">
          <input class="name-inp" id="onbEnd" type="time" value="10:00">
        </div>
      </div>
    </section>

    <div class="onb-foot">
      <div class="onb-dots">
        <span class="onb-dot" id="onbDot0"></span>
        <span class="onb-dot" id="onbDot1"></span>
        <span class="onb-dot" id="onbDot2"></span>
      </div>
      <div class="onb-actions">
        <button class="btn-pill" id="onbBackBtn" onclick="prevOnboarding()">Back</button>
        <button class="btn-pill gold" id="onbNextBtn" onclick="nextOnboarding()">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- PAGES -->
<div id="pages">

  <!-- HOME -->
  <div class="page active" id="page-home">
    <p class="eyebrow" id="appNameLabel">Researcher Timetable</p>
    <div class="status-bar">
      <div class="date-time-block">
        <div class="date-str" id="dateEl"></div>
        <div class="clock-str" id="clkEl"></div>
      </div>
      <div class="theme-toggle" onclick="toggleTheme()">
        <button class="t-pill" id="darkPill">D</button>
        <button class="t-pill" id="lightPill">L</button>
      </div>
    </div>

    <!-- HERO active block -->
    <div class="hero-card idle" id="heroCard">
      <div class="hero-top">
        <span class="hero-label idle-lbl" id="heroLabel">NO ACTIVE BLOCK</span>
        <span class="hero-time-left idle-time" id="heroTimeLeft">-</span>
      </div>
      <div class="hero-block-name" id="heroName"><span id="heroIcon">-</span><span id="heroTitle">Rest time</span></div>
      <div class="hero-focus" id="heroFocus">No scheduled block right now.</div>
      <div class="ins-remain" style="margin-top:0">
        <div class="ins-remain-top">
          <span id="insStartText">Starts --:--</span>
          <span id="insEndText">Ends --:--</span>
        </div>
        <div class="ins-remain-track"><div class="ins-remain-fill" id="insRemainFill"></div></div>
        <div class="ins-remain-now" id="insRemainText">No active block</div>
      </div>
      <div class="hero-progress-row" style="margin-top:10px">
        <div class="hero-prog-track"><div class="hero-prog-fill" id="heroProg" style="width:0%"></div></div>
        <span class="hero-prog-pct" id="heroPct">0%</span>
      </div>
    </div>

    <!-- NEXT BLOCK -->
    <div class="next-card" id="nextCard" style="display:none">
      <div class="next-icon" id="nextIcon">N</div>
      <div class="next-content">
        <div class="next-label">Up Next</div>
        <div class="next-name" id="nextName">-</div>
        <div class="next-time" id="nextTime">-</div>
      </div>
    </div>

    <!-- MINI STATS -->
    <div class="streak-row">
      <div class="mini-stat"><div class="mini-stat-val" id="mToday">0%</div><div class="mini-stat-lbl">Today</div></div>
      <div class="mini-stat"><div class="mini-stat-val" id="mStreak">0</div><div class="mini-stat-lbl">Streak</div></div>
      <div class="mini-stat"><div class="mini-stat-val" id="mAvg">-</div><div class="mini-stat-lbl">7-Day Avg</div></div>
    </div>

    <!-- STREAK DOTS -->
    <div class="dots-row">
      <span class="dots-label">Last 7 Days</span>
      <div class="dots-wrap" id="dotsEl"></div>
    </div>

    <div class="home-insights">
      <div class="ins-head">
        <div>
          <p class="eyebrow" style="margin-bottom:2px">Insights</p>
        </div>
        <div class="ins-tabs">
          <button class="ins-tab active" id="insWeekBtn" onclick="setInsightsPeriod('week')">Week</button>
          <button class="ins-tab" id="insMonthBtn" onclick="setInsightsPeriod('month')">Month</button>
        </div>
      </div>
      <div class="ins-graph" id="insGraph"></div>
      <p class="auth-help" id="insSummary" style="margin-top:8px;margin-bottom:0">Weekly completion trend.</p>
      <div class="actions-row">
        <button class="btn-pill teal" onclick="goPage('stats')">View Full Stats</button>
      </div>
    </div>
  </div>

  <!-- SCHEDULE -->
  <div class="page" id="page-schedule">
    <p class="eyebrow">Daily Schedule</p>
    <div class="toolbar">
      <span class="toolbar-label" id="toolbarLabel">Blocks</span>
      <div class="toolbar-actions">
        <button class="btn-pill" id="editBtn" onclick="toggleEdit()">Edit</button>
        <button class="btn-pill teal" id="addBtn" onclick="addBlock()" style="display:none">+ Add</button>
      </div>
    </div>
    <div class="edit-hint" id="editHint">Drag to reorder | Choose start/end times | Tap text to edit</div>
    <div class="schedule-summary" id="scheduleSummary">Done 0/0 <span>Idle</span></div>
    <div class="tl" id="tl"></div>
    <div class="actions-row">
      <button class="btn-pill ghost" onclick="resetDay()">Reset Day</button>
      <button class="btn-pill teal" onclick="exportLog()">Export</button>
      <button class="btn-pill danger" id="resetSchedBtn" onclick="resetSchedule()" style="display:none">Reset</button>
    </div>
  </div>

  <!-- STATS -->
  <div class="page" id="page-stats">
    <p class="eyebrow">Analytics</p>
    <p class="page-title">Your <em>Progress</em></p>

    <div class="stats-grid">
      <div class="stat-card"><div class="stat-v" id="st-today">0%</div><div class="stat-l">Today</div></div>
      <div class="stat-card"><div class="stat-v" id="st-avg">-</div><div class="stat-l">7-Day Avg</div></div>
      <div class="stat-card"><div class="stat-v" id="st-streak">0</div><div class="stat-l">Streak</div><div class="stat-sub" id="st-streak-sub"></div></div>
      <div class="stat-card"><div class="stat-v" id="st-days">0</div><div class="stat-l">Days Logged</div></div>
      <div class="stat-card wide"><div class="stat-v" id="st-best">0</div><div class="stat-l">Best Streak</div></div>
    </div>

    <div class="ins-meta" style="margin-top:10px">
      <div class="ins-chip"><b>Top Activity</b><span id="insTopAct">-</span></div>
      <div class="ins-chip"><b>Most Missed</b><span id="insMissed">-</span></div>
      <div class="ins-chip"><b>Best Day</b><span id="insBestDay">-</span></div>
      <div class="ins-chip"><b>Consistency</b><span id="insConsistency">-</span></div>
      <div class="ins-chip"><b>Avg Done Time</b><span id="insAvgTime">-</span></div>
      <div class="ins-chip"><b>Focus Balance</b><span id="insFocus">-</span></div>
      <div class="ins-chip"><b>On-Time Start</b><span id="insOnTime">-</span></div>
      <div class="ins-chip"><b>Current Run</b><span id="insRun">-</span></div>
    </div>

    <p class="eyebrow" style="margin-bottom:8px">History</p>
    <div class="history-list" id="historyList"></div>
  </div>

  <!-- SETTINGS -->
  <div class="page" id="page-settings">
    <p class="eyebrow">Settings</p>
    <p class="page-title">App <em>Controls</em></p>
    <div class="widget-card">
      <h3>App Name</h3>
      <p>Set a custom name for this device. This updates in-app labels only.</p>
      <div class="name-row">
        <input class="name-inp" id="appNameInput" maxlength="40" placeholder="Enter app name">
      </div>
      <div class="name-btns">
        <button class="btn-pill" onclick="saveAppName()">Save Name</button>
        <button class="btn-pill danger" onclick="resetAppName()">Reset</button>
      </div>
    </div>
    <div class="widget-card">
      <h3>Account</h3>
      <p class="auth-help" id="settingsAuthState">Not signed in</p>
      <div class="auth-row">
        <button class="btn-pill" onclick="syncNow()">Sync Now</button>
        <button class="btn-pill danger" onclick="signOut()">Sign Out</button>
      </div>
    </div>
    <div class="widget-card">
      <h3>Cloud Sync</h3>
      <p>Sign in to sync progress across devices, updates, and reinstalls.</p>
      <div class="auth-grid" id="authOut">
        <input class="name-inp" id="authEmail" type="email" placeholder="Email address" autocomplete="email">
        <input class="name-inp" id="authPass" type="password" placeholder="Password (min 6 chars)" autocomplete="current-password">
        <div class="auth-row">
          <button class="btn-pill" onclick="signIn()">Sign In</button>
          <button class="btn-pill teal" onclick="signUp()">Sign Up</button>
          <button class="btn-pill" onclick="sendReset()">Reset Password</button>
          <button class="btn-pill" onclick="resendVerification()">Resend Verify</button>
        </div>
      </div>
      <div id="authIn" style="display:none">
        <p class="auth-help">Signed in as <strong id="authUserEmail">-</strong></p>
        <input class="name-inp" id="newPass" type="password" placeholder="New password (optional)" autocomplete="new-password">
        <div class="auth-row">
          <button class="btn-pill" onclick="syncNow()">Sync Now</button>
          <button class="btn-pill" onclick="changePassword()">Update Password</button>
          <button class="btn-pill danger" onclick="undoLastSnapshot()">Undo Last Local Snapshot</button>
          <button class="btn-pill danger" onclick="signOut()">Sign Out</button>
        </div>
      </div>
      <div class="sync-status" id="syncStatus">Cloud sync: local only</div>
      <div class="conflict-box" id="conflictBox" style="display:none">
        <div class="conflict-title">Sync conflict detected</div>
        <p class="auth-help" id="conflictMsg">Both local and cloud changed recently.</p>
        <div class="auth-row">
          <button class="btn-pill teal" onclick="resolveConflict('cloud')">Use Cloud (Overwrite Local)</button>
          <button class="btn-pill" onclick="resolveConflict('local')">Upload Local to Cloud</button>
          <button class="btn-pill danger" onclick="dismissConflict()">Dismiss</button>
        </div>
      </div>
    </div>
    <div class="widget-card">
      <h3>Advanced Widget Setup</h3>
      <p>For Android native widget integration only. Not required for normal app usage.</p>
      <div class="auth-row">
        <button class="btn-pill" onclick="toggleAdvancedWidget()">Show / Hide Advanced</button>
      </div>
      <div id="advancedWidgetWrap" style="display:none">
        <div class="widget-card" style="margin-top:10px">
          <h3>Widget Setup Assistant</h3>
          <p>Native Android widget needs one-time setup in the Android app.</p>
          <ol class="assist-list">
            <li>Copy your Widget Data URL.</li>
            <li>Paste URL in <strong>WidgetRepository.kt</strong>.</li>
            <li>Install widget app and add widget on phone home screen.</li>
            <li>Use widget refresh action after schedule updates.</li>
          </ol>
          <div class="auth-row">
            <button class="btn-pill" onclick="copyUrl()">Copy Endpoint URL</button>
            <button class="btn-pill teal" onclick="testWidgetEndpoint()">Test Endpoint</button>
          </div>
          <div class="assist-state" id="widgetAssistState">Assistant: waiting for endpoint test</div>
        </div>
        <div class="widget-card" style="margin-top:10px">
          <h3>Your Widget Data URL</h3>
          <p>Your runtime endpoint serves JSON at this path for external widgets.</p>
          <p style="margin-top:6px">Paste this URL into <strong>app/src/main/java/com/researchertimetable/widget/WidgetRepository.kt</strong>.</p>
          <div class="code-block" id="widgetUrl">https://YOUR-DOMAIN.com/widget-data.json</div>
          <button class="copy-btn" onclick="copyUrl()">Copy URL</button>
        </div>
        <div class="widget-card" style="margin-top:10px">
          <h3>Native App Flow</h3>
          <p>1. Open <strong>android-widget-starter</strong> in Android Studio.</p>
          <p>2. Set endpoint URL in <strong>WidgetRepository.kt</strong>.</p>
          <p>3. Install app on phone and add the widget.</p>
          <p>4. Use <strong>Refresh Widget Now</strong> for immediate sync.</p>
        </div>
        <div class="widget-card" style="margin-top:10px">
          <h3>Widget Data Preview</h3>
          <p>Preview payload. Your native widget reads the deployed endpoint URL.</p>
          <div class="code-block" id="widgetDataPreview">Loading...</div>
        </div>
      </div>
    </div>
    <div class="widget-card">
      <h3>Onboarding</h3>
      <p>Replay the guided onboarding anytime.</p>
      <div class="auth-row">
        <button class="btn-pill" onclick="replayOnboarding()">Replay Onboarding</button>
      </div>
    </div>
    <div class="widget-card">
      <h3>QA Diagnostics</h3>
      <p>Run a quick smoke-check for key app systems.</p>
      <div class="auth-row">
        <button class="btn-pill teal" onclick="runDiagnostics()">Run Diagnostics</button>
      </div>
      <div class="diag-list" id="diagList">
        <div class="diag-item">Diagnostics not run yet.</div>
      </div>
    </div>
    <div class="widget-card">
      <h3>Sync History</h3>
      <p>Recent local snapshots (for conflict recovery/undo).</p>
      <div class="code-block" id="snapshotPreview">No snapshots yet.</div>
      <div class="auth-row">
        <button class="btn-pill" onclick="refreshSnapshotPreview()">Refresh History</button>
      </div>
    </div>
  </div>

</div>

<!-- BOTTOM NAV -->
<div id="bottom-nav">
  <button class="nav-btn active" id="nav-home" onclick="goPage('home')" aria-label="Open Home">
    <span class="nav-icon">H</span>
    <span class="nav-label">Home</span>
  </button>
  <button class="nav-btn" id="nav-schedule" onclick="goPage('schedule')" aria-label="Open Schedule">
    <span class="nav-icon">S</span>
    <span class="nav-label">Schedule</span>
  </button>
  <button class="nav-btn" id="nav-stats" onclick="goPage('stats')" aria-label="Open Stats">
    <span class="nav-icon">T</span>
    <span class="nav-label">Stats</span>
  </button>
  <button class="nav-btn" id="nav-settings" onclick="goPage('settings')" aria-label="Open Settings">
    <span class="nav-icon">E</span>
    <span class="nav-label">Settings</span>
  </button>
</div>
<div id="toast" role="status" aria-live="polite"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*  DATA  */
const DEFAULT=[];

let schedule=(()=>{try{const s=JSON.parse(localStorage.getItem('rdt_sched'));return s?.length?s:JSON.parse(JSON.stringify(DEFAULT));}catch{return JSON.parse(JSON.stringify(DEFAULT));}})();
let editMode=false,dragSrc=null,openNotes={},idCtr=200;
let currentPage='home';
let lastRenderedMinute=null;
let toastTimer=null;
const APP_NAME_KEY='rdt_app_name';
const DEFAULT_APP_NAME='Researcher Timetable';
const STATE_UPDATED_KEY='rdt_state_updated_at';
const ONBOARD_KEY='rdt_onboarding_done';
const LOCAL_ONLY_KEY='rdt_local_only_mode';
const SNAP_KEY='rdt_state_snapshots';
const ADV_WIDGET_KEY='rdt_adv_widget_open';
let supabaseClient=null;
let currentUser=null;
let cloudSyncTimer=null;
let cloudBusy=false;
let applyingRemote=false;
let suppressCloudSync=false;
let onboardStep=0;
let pendingConflictRow=null;
let lastSnapshotMs=0;
let insightsPeriod='week';

const saveSchedule=(opts={})=>{
  localStorage.setItem('rdt_sched',JSON.stringify(schedule));
  if(!opts.silent)markLocalStateUpdated();
};
const loadData=()=>{try{return JSON.parse(localStorage.getItem('rdt_data')||'{}')}catch{return{}}};
const saveData=(d,opts={})=>{
  localStorage.setItem('rdt_data',JSON.stringify(d));
  if(!opts.silent)markLocalStateUpdated();
};
const cleanName=v=>(v||'').replace(/\s+/g,' ').trim().slice(0,40);
function markLocalStateUpdated(){
  localStorage.setItem(STATE_UPDATED_KEY,new Date().toISOString());
  const now=Date.now();
  if(now-lastSnapshotMs>120000){
    saveLocalSnapshot('auto');
    lastSnapshotMs=now;
  }
  if(!applyingRemote)queueCloudPush();
}
function localUpdatedMs(){
  const ts=Date.parse(localStorage.getItem(STATE_UPDATED_KEY)||'');
  return Number.isFinite(ts)?ts:0;
}
function hasMeaningfulLocalState(){
  const data=loadData();
  const hasData=Object.keys(data).length>0;
  const hasName=!!cleanName(localStorage.getItem(APP_NAME_KEY)||'');
  const hasTheme=(localStorage.getItem('rdt_theme')||'dark')!=='dark';
  const hasCustomSched=JSON.stringify(schedule)!==JSON.stringify(DEFAULT);
  return hasData||hasName||hasTheme||hasCustomSched;
}
function readSnapshots(){
  try{
    const arr=JSON.parse(localStorage.getItem(SNAP_KEY)||'[]');
    return Array.isArray(arr)?arr:[];
  }catch{return[];}
}
function writeSnapshots(arr){
  localStorage.setItem(SNAP_KEY,JSON.stringify(arr.slice(0,12)));
}
function saveLocalSnapshot(reason='manual'){
  const snap={
    at:new Date().toISOString(),
    reason,
    sched:schedule,
    data:loadData(),
    app_name:cleanName(localStorage.getItem(APP_NAME_KEY)||''),
    theme:localStorage.getItem('rdt_theme')||'dark'
  };
  const arr=readSnapshots();
  arr.unshift(snap);
  writeSnapshots(arr);
}
function restoreSnapshot(snap){
  if(!snap)return;
  applyingRemote=true;
  suppressCloudSync=true;
  try{
    schedule=Array.isArray(snap.sched)&&snap.sched.length?snap.sched:JSON.parse(JSON.stringify(DEFAULT));
    saveSchedule({silent:true});
    saveData((snap.data&&typeof snap.data==='object')?snap.data:{},{silent:true});
    if(snap.app_name)localStorage.setItem(APP_NAME_KEY,cleanName(snap.app_name));else localStorage.removeItem(APP_NAME_KEY);
    applyTheme(snap.theme==='light'?'light':'dark',{silent:true});
    localStorage.setItem(STATE_UPDATED_KEY,new Date().toISOString());
    applyAppName();
    normalizeAllData();
    buildTimeline();
    updateHome();
    if(currentPage==='stats')renderStatsPage();
  } finally {
    suppressCloudSync=false;
    applyingRemote=false;
  }
}
function undoLastSnapshot(){
  const arr=readSnapshots();
  if(!arr.length){showToast('No snapshot available');return;}
  restoreSnapshot(arr[0]);
  markLocalStateUpdated();
  refreshSnapshotPreview();
  showToast('Restored latest snapshot');
}
function refreshSnapshotPreview(){
  const el=document.getElementById('snapshotPreview');
  if(!el)return;
  const arr=readSnapshots().slice(0,6);
  if(!arr.length){el.textContent='No snapshots yet.';return;}
  el.textContent=arr.map((s,i)=>`${i+1}. ${s.at} (${s.reason||'saved'})`).join('\n');
}
function getAppName(){
  const n=cleanName(localStorage.getItem(APP_NAME_KEY)||'');
  return n||DEFAULT_APP_NAME;
}
function applyAppName(){
  const name=getAppName();
  document.title=name;
  const appleTitle=document.querySelector('meta[name="apple-mobile-web-app-title"]');
  if(appleTitle)appleTitle.setAttribute('content',name);
  const lbl=document.getElementById('appNameLabel');
  if(lbl)lbl.textContent=name;
  const widgetName=document.getElementById('widgetAppName');
  if(widgetName)widgetName.textContent=name;
  const installText=document.getElementById('installText');
  if(installText)installText.textContent=`Add ${name} to Home Screen for the full app experience`;
  const inp=document.getElementById('appNameInput');
  if(inp&&document.activeElement!==inp)inp.value=(name===DEFAULT_APP_NAME?'':name);
}
function saveAppName(){
  const inp=document.getElementById('appNameInput');
  if(!inp)return;
  const next=cleanName(inp.value);
  if(next)localStorage.setItem(APP_NAME_KEY,next);
  else localStorage.removeItem(APP_NAME_KEY);
  markLocalStateUpdated();
  applyAppName();
  showToast(next?'App name saved':'App name reset');
}
function resetAppName(){
  localStorage.removeItem(APP_NAME_KEY);
  const inp=document.getElementById('appNameInput');
  if(inp)inp.value='';
  markLocalStateUpdated();
  applyAppName();
  showToast('App name reset');
}
function onboardingDone(){return localStorage.getItem(ONBOARD_KEY)==='1';}
function closeOnboarding(){
  const root=document.getElementById('onboard');
  if(root)root.classList.remove('show');
  document.body.classList.remove('onboard-open');
}
function finishOnboarding(){
  localStorage.setItem(ONBOARD_KEY,'1');
  closeOnboarding();
}
function updateOnboardingStep(){
  const root=document.getElementById('onboard');
  if(!root)return;
  root.dataset.step=String(onboardStep);
  const stepLbl=document.getElementById('onbStepLabel');
  if(stepLbl)stepLbl.textContent=`Step ${onboardStep+1} of 3`;
  for(let i=0;i<3;i++){
    const dot=document.getElementById('onbDot'+i);
    if(dot)dot.classList.toggle('on',i===onboardStep);
  }
  const back=document.getElementById('onbBackBtn');
  const next=document.getElementById('onbNextBtn');
  if(back)back.style.display=onboardStep===0?'none':'inline-flex';
  if(next)next.textContent=onboardStep===2?'Create Schedule':'Next';
}
function openOnboarding(){
  const root=document.getElementById('onboard');
  if(!root)return;
  onboardStep=0;
  root.classList.add('show');
  document.body.classList.add('onboard-open');
  updateOnboardingStep();
}
function nextOnboarding(){
  if(onboardStep===1&&!currentUser&&localStorage.getItem(LOCAL_ONLY_KEY)!=='1'){
    showToast('Sign in or choose Continue Local');
    return;
  }
  if(onboardStep>=2){
    if(!seedScheduleFromOnboarding()){
      showToast('Add first task and time to continue');
      return;
    }
    finishOnboarding();
    return;
  }
  onboardStep=Math.min(2,onboardStep+1);
  updateOnboardingStep();
}
function prevOnboarding(){
  onboardStep=Math.max(0,onboardStep-1);
  updateOnboardingStep();
}
function maybeShowOnboarding(){
  if(!onboardingDone()){
    openOnboarding();
    return;
  }
  if(!currentUser&&localStorage.getItem(LOCAL_ONLY_KEY)!=='1'){
    openOnboarding();
    onboardStep=1;
    updateOnboardingStep();
  }
}
function replayOnboarding(){
  localStorage.removeItem(ONBOARD_KEY);
  localStorage.removeItem(LOCAL_ONLY_KEY);
  openOnboarding();
  showToast('Onboarding replay started');
}
function seedScheduleFromOnboarding(){
  if(schedule.length>0)return true;
  const name=(document.getElementById('onbTask')?.value||'').trim();
  if(!name)return false;
  const s=parseTime(document.getElementById('onbStart')?.value||'');
  const e=parseTime(document.getElementById('onbEnd')?.value||'');
  if(s===null||e===null)return false;
  const ss=Math.min(s,e);
  const ee=(e<=s)?Math.min(1439,ss+60):e;
  const ico=(name[0]||'N').toUpperCase();
  schedule=[{id:'s'+(++idCtr),t:`${minsToTime(ss)}-${minsToTime(ee)}`,a:name,f:'Focus session',i:ico,s:ss,e:ee}];
  saveSchedule();
  normalizeAllData();
  buildTimeline();
  updateHome();
  return true;
}
function toggleAdvancedWidget(){
  const wrap=document.getElementById('advancedWidgetWrap');
  if(!wrap)return;
  const next=wrap.style.display==='none'?'block':'none';
  wrap.style.display=next;
  localStorage.setItem(ADV_WIDGET_KEY,next==='block'?'1':'0');
  if(next==='block')updateWidgetPreview();
}
function renderAdvancedWidget(){
  const wrap=document.getElementById('advancedWidgetWrap');
  if(!wrap)return;
  const open=localStorage.getItem(ADV_WIDGET_KEY)==='1';
  wrap.style.display=open?'block':'none';
  if(open)updateWidgetPreview();
}
function setInsightsPeriod(p){
  insightsPeriod=(p==='month')?'month':'week';
  const wb=document.getElementById('insWeekBtn');
  const mb=document.getElementById('insMonthBtn');
  if(wb)wb.classList.toggle('active',insightsPeriod==='week');
  if(mb)mb.classList.toggle('active',insightsPeriod==='month');
  updateHome();
}
function renderInsightsGraph(data,N){
  const graph=document.getElementById('insGraph');
  const summary=document.getElementById('insSummary');
  if(!graph)return;
  const isMonth=insightsPeriod==='month';
  const periodKeys=isMonth
    ? (() => {
        const all=lastDateKeys(30);
        const sample=all.filter((_,i)=>i%3===0);
        const t=todayKey();
        if(sample[sample.length-1]!==t){
          sample.push(t);
          while(sample.length>10)sample.shift();
        }
        return sample;
      })()
    : lastDateKeys(7); // fixed 7 bars (Sun..Sat labels by date key)
  const points=periodKeys.map(k=>({k,p:Math.round(((data[k]?.done?.length||0)/(N||1))*100)}));
  const today=todayKey();
  graph.innerHTML=`
    <div class="ins-bars ${isMonth?'month':'week'}">
      ${points.map((x,idx)=>{
        const d=new Date(x.k+'T00:00:00');
        const day3=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
        const mon3=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()];
        const lbl=isMonth?`${d.getDate()} ${mon3}`:day3;
        const h=Math.max(4,Math.min(100,x.p));
        const last=idx===points.length-1;
        const isToday=x.k===today;
        return `<div class="ins-col ${isToday?'today':''}"><span class="ins-val">${x.p}%</span><div class="ins-track"><div class="ins-fill ${last?'last':''}" style="height:${h}%"></div></div><span class="ins-lbl">${lbl}</span>${isToday?'<span class="ins-today-tag">Today</span>':'<span class="ins-today-tag">&nbsp;</span>'}</div>`;
      }).join('')}
    </div>
  `;
  const avg=Math.round(points.reduce((a,b)=>a+b.p,0)/points.length);
  if(summary)summary.textContent=`${isMonth?'Month':'Week'} avg completion: ${avg}%`;
}
function renderExtendedInsights(data,N,doneToday){
  const weekKeys=lastDateKeys(7);
  const blocksById=Object.fromEntries(schedule.map(s=>[s.id,s]));
  const doneCountById={};
  const missedCountById={};
  const catDone={ 'Deep Work':0,'Support':0,'Recovery':0 };
  const doneTimes=[];
  let consistencyHits=0;
  let bestDay={k:'',p:-1};
  let onTimeNum=0,onTimeDen=0;

  weekKeys.forEach(wk=>{
    const d=getDay(data,wk);
    const p=Math.round(((d.done?.length||0)/(N||1))*100);
    if(p>=70)consistencyHits++;
    if(p>bestDay.p)bestDay={k:wk,p};
    schedule.forEach((s,idx)=>{
      const id=s.id;
      const isDone=(d.done||[]).includes(id);
      if(isDone){
        doneCountById[id]=(doneCountById[id]||0)+1;
        catDone[classifyBlock(s)]++;
        const iso=d.doneAt?.[id];
        if(iso){
          const dt=new Date(iso);
          if(!isNaN(dt))doneTimes.push(dt.getHours()*60+dt.getMinutes());
        }
      }else{
        missedCountById[id]=(missedCountById[id]||0)+1;
      }
      if(idx===0&&d.doneAt?.[id]){
        const dt=new Date(d.doneAt[id]);
        if(!isNaN(dt)){
          onTimeDen++;
          const mins=dt.getHours()*60+dt.getMinutes();
          if(mins<=s.s+60)onTimeNum++;
        }
      }
    });
  });

  const topId=Object.keys(doneCountById).sort((a,b)=>(doneCountById[b]-doneCountById[a]))[0];
  const missId=Object.keys(missedCountById).sort((a,b)=>(missedCountById[b]-missedCountById[a]))[0];
  const bestDayDate=bestDay.k?new Date(bestDay.k+'T00:00:00'):null;
  const bestDayLbl=bestDayDate?`${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][bestDayDate.getDay()]} (${bestDay.p}%)`:'-';
  const avgDoneMin=doneTimes.length?Math.round(doneTimes.reduce((a,b)=>a+b,0)/doneTimes.length):null;
  const totalCat=catDone['Deep Work']+catDone['Support']+catDone['Recovery'];
  const bal=totalCat?`D ${Math.round(catDone['Deep Work']*100/totalCat)}% / S ${Math.round(catDone['Support']*100/totalCat)}% / R ${Math.round(catDone['Recovery']*100/totalCat)}%`:'-';
  const onTime=onTimeDen?`${Math.round(onTimeNum*100/onTimeDen)}% (${onTimeNum}/${onTimeDen})`:'-';
  let run=0;
  for(let i=0;i<schedule.length;i++){
    if((doneToday||[]).includes(schedule[i].id))run++;
    else break;
  }

  const setTxt=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  setTxt('insTopAct',topId?(blocksById[topId]?.a||topId):'-');
  setTxt('insMissed',missId?(blocksById[missId]?.a||missId):'-');
  setTxt('insBestDay',bestDayLbl);
  setTxt('insConsistency',`${consistencyHits}/7 days >= 70%`);
  setTxt('insAvgTime',avgDoneMin===null?'-':minsTo12h(avgDoneMin));
  setTxt('insFocus',bal);
  setTxt('insOnTime',onTime);
  setTxt('insRun',`${run} consecutive blocks`);
}
function startLocalMode(){
  const ok=confirm('Continue without account?\n\nYour progress stays only on this device and can be lost after reinstall, clearing browser data, or changing device.');
  if(!ok)return;
  localStorage.setItem(LOCAL_ONLY_KEY,'1');
  const onboardOpen=!!document.getElementById('onboard')?.classList.contains('show');
  if(onboardOpen){
    onboardStep=2;
    updateOnboardingStep();
    showToast('Local-only mode enabled. Set first schedule block.');
  }else{
    finishOnboarding();
    setSyncStatus('Cloud sync: local-only mode (no account)');
    showToast('Local-only mode enabled');
  }
}
function toLocalKey(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
const todayKey=()=>toLocalKey(new Date());
const nowMin=()=>{const n=new Date();return n.getHours()*60+n.getMinutes();};
const minsToTime=m=>`${String(Math.floor((Math.max(0,Math.min(1439,m)))/60)).padStart(2,'0')}:${String(Math.max(0,Math.min(1439,m))%60).padStart(2,'0')}`;
const parseTime=v=>{const m=(v||'').match(/^(\d{1,2}):(\d{2})$/);if(!m)return null;const h=+m[1],mm=+m[2];if(h>23||mm>59)return null;return h*60+mm;};
const activeIdx=()=>{const m=nowMin();return schedule.findIndex(s=>m>=s.s&&m<s.e);};
const getDay=(data,k)=>{
  if(!data[k])data[k]={done:[],notes:{},doneAt:{}};
  if(!Array.isArray(data[k].done))data[k].done=[];
  if(!data[k].notes||typeof data[k].notes!=='object')data[k].notes={};
  if(!data[k].doneAt||typeof data[k].doneAt!=='object')data[k].doneAt={};
  return data[k];
};
const validIdSet=()=>new Set(schedule.map(s=>s.id));
function normalizeDayData(day,validIds){
  day.done=Array.isArray(day.done)?day.done.filter(id=>validIds.has(id)):[];
  const notes=(day.notes&&typeof day.notes==='object')?day.notes:{};
  const doneAt=(day.doneAt&&typeof day.doneAt==='object')?day.doneAt:{};
  const cleanNotes={};
  const cleanDoneAt={};
  Object.keys(notes).forEach(id=>{if(validIds.has(id))cleanNotes[id]=notes[id];});
  Object.keys(doneAt).forEach(id=>{if(validIds.has(id))cleanDoneAt[id]=doneAt[id];});
  day.notes=cleanNotes;
  day.doneAt=cleanDoneAt;
  return day;
}
function dateKeyFromOffset(daysBack){
  const d=new Date();
  d.setHours(0,0,0,0);
  d.setDate(d.getDate()-daysBack);
  return toLocalKey(d);
}
function lastDateKeys(days){
  const out=[];
  for(let i=days-1;i>=0;i--)out.push(dateKeyFromOffset(i));
  return out;
}
function classifyBlock(s){
  const t=`${s.a||''} ${s.f||''}`.toLowerCase();
  if(/break|prayer|rest|lunch|sleep/.test(t))return 'Recovery';
  if(/commute|arrival|call|wrap|admin|log|cleanup/.test(t))return 'Support';
  return 'Deep Work';
}
function minsTo12h(m){
  const mm=Math.max(0,Math.min(1439,m|0));
  const h24=Math.floor(mm/60),mn=mm%60,ap=h24>=12?'PM':'AM';
  const h=((h24+11)%12)+1;
  return `${h}:${String(mn).padStart(2,'0')} ${ap}`;
}
function normalizeAllData(){
  const data=loadData();
  const ids=validIdSet();
  let changed=false;
  Object.keys(data).forEach(k=>{
    const day=getDay(data,k);
    const beforeDone=JSON.stringify(day.done||[]);
    const beforeNotes=JSON.stringify(day.notes||{});
    normalizeDayData(day,ids);
    if(beforeDone!==JSON.stringify(day.done)||beforeNotes!==JSON.stringify(day.notes))changed=true;
  });
  if(changed)saveData(data,{silent:true});
  return data;
}
function getStreakStats(data,totalBlocks){
  const keys=Object.keys(data).sort();
  const threshold=Math.ceil(totalBlocks*0.7);
  let currentStreak=0;
  for(let i=keys.length-1;i>=0;i--){
    if((data[keys[i]]?.done?.length||0)>=threshold)currentStreak++;
    else break;
  }
  let bestStreak=0,run=0;
  for(let i=0;i<keys.length;i++){
    if((data[keys[i]]?.done?.length||0)>=threshold){run++;if(run>bestStreak)bestStreak=run;}
    else run=0;
  }
  return{keys,currentStreak,bestStreak};
}

/*  CLOUD SYNC (SUPABASE PHASE 1)  */
function setSyncStatus(msg){
  const el=document.getElementById('syncStatus');
  if(el)el.textContent=msg;
}
function setConflictBox(show,msg=''){
  const box=document.getElementById('conflictBox');
  const txt=document.getElementById('conflictMsg');
  if(txt&&msg)txt.textContent=msg;
  if(box)box.style.display=show?'block':'none';
}
function dismissConflict(){
  pendingConflictRow=null;
  setConflictBox(false);
}
function renderAuthState(){
  const out=document.getElementById('authOut');
  const inn=document.getElementById('authIn');
  const em=document.getElementById('authUserEmail');
  const setAuth=document.getElementById('settingsAuthState');
  if(out)out.style.display=currentUser?'none':'grid';
  if(inn)inn.style.display=currentUser?'block':'none';
  if(em)em.textContent=currentUser?.email||'-';
  if(setAuth)setAuth.textContent=currentUser?`Signed in as ${currentUser.email}`:'Not signed in';
  const pw=document.getElementById('newPass');
  if(pw&&currentUser)pw.value='';
}
function collectLocalState(){
  return {
    sched:schedule,
    data:normalizeAllData(),
    app_name:cleanName(localStorage.getItem(APP_NAME_KEY)||''),
    theme:localStorage.getItem('rdt_theme')||'dark'
  };
}
function applyRemoteState(row){
  applyingRemote=true;
  suppressCloudSync=true;
  try{
    saveLocalSnapshot('pre-remote');
    schedule=Array.isArray(row.sched)&&row.sched.length?row.sched:JSON.parse(JSON.stringify(DEFAULT));
    saveSchedule({silent:true});
    saveData((row.data&&typeof row.data==='object')?row.data:{},{silent:true});
    const remoteName=cleanName(row.app_name||'');
    if(remoteName)localStorage.setItem(APP_NAME_KEY,remoteName);else localStorage.removeItem(APP_NAME_KEY);
    applyTheme(row.theme==='light'?'light':'dark',{silent:true});
    localStorage.setItem(STATE_UPDATED_KEY,row.updated_at||new Date().toISOString());
    applyAppName();
    normalizeAllData();
    buildTimeline();
    updateHome();
    if(currentPage==='stats')renderStatsPage();
    if(currentPage==='settings')refreshSnapshotPreview();
  } finally {
    suppressCloudSync=false;
    applyingRemote=false;
  }
}
function statesDiffer(a,b){
  return JSON.stringify(a.sched||[])!==JSON.stringify(b.sched||[])||
    JSON.stringify(a.data||{})!==JSON.stringify(b.data||{})||
    cleanName(a.app_name||'')!==cleanName(b.app_name||'')||
    (a.theme||'dark')!==(b.theme||'dark');
}
function showConflict(row){
  pendingConflictRow=row;
  setConflictBox(true,'Local and cloud changed recently. Choose which version to keep.');
  setSyncStatus('Cloud sync: conflict requires action');
}
async function resolveConflict(mode){
  if(!pendingConflictRow){setConflictBox(false);return;}
  const row=pendingConflictRow;
  pendingConflictRow=null;
  if(mode==='cloud'){
    applyRemoteState(row);
    setSyncStatus('Cloud sync: cloud version applied');
  }else{
    await pushCloudState('conflict-local');
  }
  setConflictBox(false);
}
async function pushCloudState(reason='sync'){
  if(!supabaseClient||!currentUser||cloudBusy||suppressCloudSync)return;
  cloudBusy=true;
  try{
    const payload=collectLocalState();
    payload.user_id=currentUser.id;
    payload.updated_at=new Date().toISOString();
    const {error}=await supabaseClient.from('user_state').upsert(payload);
    if(error)throw error;
    localStorage.setItem(STATE_UPDATED_KEY,payload.updated_at);
    setSyncStatus(`Cloud sync: saved (${reason})`);
  }catch(err){
    setSyncStatus(`Cloud sync error: ${err.message||'failed to save'}`);
  }finally{
    cloudBusy=false;
  }
}
async function pullCloudState(reason='sync'){
  if(!supabaseClient||!currentUser||cloudBusy)return;
  cloudBusy=true;
  try{
    const {data:row,error}=await supabaseClient.from('user_state').select('*').eq('user_id',currentUser.id).maybeSingle();
    if(error)throw error;
    if(!row){
      await pushCloudState('first sync');
      return;
    }
    const remoteMs=Date.parse(row.updated_at||'');
    const localMs=localUpdatedMs();
    const localState=collectLocalState();
    if(remoteMs>0&&localMs>0&&Math.abs(remoteMs-localMs)<=15*60*1000&&statesDiffer(row,localState)){
      showConflict(row);
      return;
    }
    if(!localMs){
      if(hasMeaningfulLocalState()&&remoteMs<=0)await pushCloudState(reason);
      else applyRemoteState(row);
      setSyncStatus(`Cloud sync: loaded (${reason})`);
      return;
    }
    if(remoteMs>localMs+1000){
      applyRemoteState(row);
      setSyncStatus(`Cloud sync: pulled newer data (${reason})`);
    }else if(localMs>remoteMs+1000){
      await pushCloudState(reason);
    }else{
      setSyncStatus('Cloud sync: up to date');
    }
  }catch(err){
    setSyncStatus(`Cloud sync error: ${err.message||'failed to load'}`);
  }finally{
    cloudBusy=false;
  }
}
function queueCloudPush(){
  if(!currentUser||!supabaseClient||suppressCloudSync||applyingRemote)return;
  if(cloudSyncTimer)clearTimeout(cloudSyncTimer);
  cloudSyncTimer=setTimeout(()=>pushCloudState('auto'),700);
}
async function initSupabase(){
  try{
    if(!window.supabase?.createClient){
      setSyncStatus('Cloud sync unavailable: library load failed');
      return;
    }
    const r=await fetch('/api/supabase-config',{cache:'no-store'});
    if(!r.ok)throw new Error('config endpoint unavailable');
    const cfg=await r.json();
    if(!cfg.url||!cfg.anonKey){
      setSyncStatus('Cloud sync unavailable: missing env vars');
      return;
    }
    supabaseClient=window.supabase.createClient(cfg.url,cfg.anonKey);
    const {data:{session}}=await supabaseClient.auth.getSession();
    currentUser=session?.user||null;
    renderAuthState();
    if(currentUser)await pullCloudState('startup');
    else setSyncStatus('Cloud sync: signed out');
    maybeShowOnboarding();
    supabaseClient.auth.onAuthStateChange(async(_evt,sessionNow)=>{
      currentUser=sessionNow?.user||null;
      renderAuthState();
      if(currentUser){
        const onboardOpen=!!document.getElementById('onboard')?.classList.contains('show');
        if(onboardOpen&&!onboardingDone()){
          onboardStep=2;
          updateOnboardingStep();
        }else{
          finishOnboarding();
        }
        setSyncStatus('Cloud sync: signed in, syncing...');
        await pullCloudState('login');
      }else{
        setSyncStatus('Cloud sync: signed out');
        maybeShowOnboarding();
      }
    });
  }catch(err){
    setSyncStatus(`Cloud sync unavailable: ${err.message||'init failed'}`);
  }
}
async function signIn(emailId='authEmail',passId='authPass',finishAfter=false){
  if(!supabaseClient){showToast('Cloud sync not ready');return;}
  const email=(document.getElementById(emailId)?.value||'').trim();
  const password=(document.getElementById(passId)?.value||'').trim();
  if(!email||!password){showToast('Enter email and password');return;}
  const {error}=await supabaseClient.auth.signInWithPassword({email,password});
  if(error){showToast(error.message||'Sign in failed');return;}
  const {data:{session}}=await supabaseClient.auth.getSession();
  currentUser=session?.user||currentUser;
  renderAuthState();
  localStorage.removeItem(LOCAL_ONLY_KEY);
  const onboardOpen=!!document.getElementById('onboard')?.classList.contains('show');
  if(onboardOpen&&!onboardingDone()){
    onboardStep=2;
    updateOnboardingStep();
  }
  if(finishAfter){
    seedScheduleFromOnboarding();
    finishOnboarding();
  }
  setSyncStatus(currentUser?`Cloud sync: signed in as ${currentUser.email}`:'Cloud sync: signed in');
  showToast('Signed in');
}
async function signUp(emailId='authEmail',passId='authPass'){
  if(!supabaseClient){showToast('Cloud sync not ready');return;}
  const email=(document.getElementById(emailId)?.value||'').trim();
  const password=(document.getElementById(passId)?.value||'').trim();
  if(!email||!password){showToast('Enter email and password');return;}
  const {error}=await supabaseClient.auth.signUp({email,password});
  if(error){showToast(error.message||'Sign up failed');return;}
  showToast('Sign up successful. Verify email if prompted.');
}
async function sendReset(emailId='authEmail'){
  if(!supabaseClient){showToast('Cloud sync not ready');return;}
  const email=(document.getElementById(emailId)?.value||'').trim();
  if(!email){showToast('Enter your email first');return;}
  const {error}=await supabaseClient.auth.resetPasswordForEmail(email,{
    redirectTo:window.location.origin+window.location.pathname
  });
  if(error){showToast(error.message||'Reset request failed');return;}
  showToast('Password reset email sent');
}
async function resendVerification(emailId='authEmail'){
  if(!supabaseClient){showToast('Cloud sync not ready');return;}
  const email=(document.getElementById(emailId)?.value||'').trim();
  if(!email){showToast('Enter your email first');return;}
  const {error}=await supabaseClient.auth.resend({type:'signup',email});
  if(error){showToast(error.message||'Resend failed');return;}
  showToast('Verification email sent');
}
async function changePassword(){
  if(!supabaseClient||!currentUser){showToast('Sign in first');return;}
  const pwd=(document.getElementById('newPass')?.value||'').trim();
  if(!pwd||pwd.length<6){showToast('New password must be 6+ chars');return;}
  const {error}=await supabaseClient.auth.updateUser({password:pwd});
  if(error){showToast(error.message||'Update failed');return;}
  document.getElementById('newPass').value='';
  showToast('Password updated');
}
async function signOut(){
  if(!supabaseClient)return;
  const {error}=await supabaseClient.auth.signOut();
  if(error){showToast(error.message||'Sign out failed');return;}
  showToast('Signed out');
}
async function syncNow(){
  if(!currentUser){showToast('Sign in first');return;}
  await pullCloudState('manual');
  showToast('Sync complete');
}
async function testWidgetEndpoint(){
  const url=window.location.origin+window.location.pathname.replace('index.html','')+'widget-data.json';
  const out=document.getElementById('widgetAssistState');
  if(out)out.textContent='Assistant: testing endpoint...';
  try{
    const r=await fetch(url,{cache:'no-store'});
    const d=await r.json();
    const ok=r.ok&&typeof d==='object'&&d.updated;
    if(out)out.textContent=ok?`Assistant: endpoint OK (updated ${d.updated})`:'Assistant: endpoint returned invalid payload';
  }catch{
    if(out)out.textContent='Assistant: endpoint test failed';
  }
}
async function runDiagnostics(){
  const list=document.getElementById('diagList');
  if(!list)return;
  const rows=[];
  const push=(label,ok,detail='')=>rows.push({label,ok,detail});
  push('Supabase client ready',!!supabaseClient,!!supabaseClient?'connected config':'missing config');
  push('User signed in',!!currentUser,currentUser?.email||'not signed in');
  try{
    const u=window.location.origin+window.location.pathname.replace('index.html','')+'widget-data.json';
    const r=await fetch(u,{cache:'no-store'});
    push('Widget endpoint',r.ok,r.ok?'reachable':'request failed');
  }catch{push('Widget endpoint',false,'request exception');}
  push('Service worker support','serviceWorker' in navigator,('serviceWorker' in navigator)?'supported':'unsupported');
  push('Local storage access',(()=>{try{localStorage.setItem('__t','1');localStorage.removeItem('__t');return true;}catch{return false;}})(),'');
  list.innerHTML=rows.map(r=>`<div class="diag-item ${r.ok?'ok':'warn'}">${r.label}: ${r.ok?'OK':'Issue'}${r.detail?` (${r.detail})`:''}</div>`).join('');
}

/*  NAVIGATION  */
function goPage(name){
  const prev=currentPage;
  if(prev===name)return;
  const pages=['home','schedule','stats','settings'];
  const pi=pages.indexOf(prev),ni=pages.indexOf(name);
  document.getElementById('page-'+prev).classList.remove('active');
  document.getElementById('page-'+prev).classList.toggle('left',pi<ni);
  document.getElementById('page-'+name).classList.remove('left');
  document.getElementById('page-'+name).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('nav-'+name).classList.add('active');
  currentPage=name;
  if(name==='stats')renderStatsPage();
  if(name==='schedule'){buildTimeline();lastRenderedMinute=nowMin();}
  if(name==='settings'){refreshSnapshotPreview();renderAdvancedWidget();}
}

/*  THEME  */
let theme=localStorage.getItem('rdt_theme')||'dark';
function applyTheme(t,opts={}){
  document.documentElement.setAttribute('data-theme',t);
  document.getElementById('darkPill').classList.toggle('active',t==='dark');
  document.getElementById('lightPill').classList.toggle('active',t==='light');
  localStorage.setItem('rdt_theme',t);theme=t;
  if(!opts.silent)markLocalStateUpdated();
}
function toggleTheme(){applyTheme(theme==='dark'?'light':'dark');}
applyTheme(theme,{silent:true});

/*  HOME PAGE  */
function updateHome(){
  const data=normalizeAllData(),k=todayKey(),day=getDay(data,k);
  const N=schedule.length||1,done=day.done;
  const pct=Math.round(done.length/N*100);
  const ai=activeIdx();

  // Hero card
  const hero=document.getElementById('heroCard');
  if(ai>=0&&!done.includes(schedule[ai]?.id)){
    const s=schedule[ai];
    const rem=s.e-nowMin();
    const h=Math.floor(rem/60),m=rem%60;
    hero.classList.remove('idle');
    document.getElementById('heroLabel').textContent='NOW ACTIVE';
    document.getElementById('heroLabel').className='hero-label';
    document.getElementById('heroTimeLeft').textContent=h>0?`${h}h ${m}m`:`${m} min`;
    document.getElementById('heroTimeLeft').className='hero-time-left';
    document.getElementById('heroIcon').textContent=s.i;
    document.getElementById('heroTitle').textContent=s.a;
    document.getElementById('heroFocus').textContent=s.f;
  } else {
    hero.classList.add('idle');
    document.getElementById('heroLabel').textContent='NO ACTIVE BLOCK';
    document.getElementById('heroLabel').className='hero-label idle-lbl';
    document.getElementById('heroTimeLeft').textContent='-';
    document.getElementById('heroTimeLeft').className='hero-time-left idle-time';
    document.getElementById('heroIcon').textContent='-';
    document.getElementById('heroTitle').textContent='Free time';
    document.getElementById('heroFocus').textContent='No scheduled block right now.';
  }
  document.getElementById('heroProg').style.width=pct+'%';
  document.getElementById('heroPct').textContent=pct+'%';

  // Next block
  let nextIdx=-1;
  const m=nowMin();
  for(let i=0;i<schedule.length;i++){
    if(schedule[i].s>m&&!done.includes(schedule[i].id)){nextIdx=i;break;}
  }
  if(ai>=0&&!done.includes(schedule[ai]?.id)){
    // already showing active, find next after active
    for(let i=ai+1;i<schedule.length;i++){
      if(!done.includes(schedule[i].id)){nextIdx=i;break;}
    }
  }
  const nc=document.getElementById('nextCard');
  if(nextIdx>=0){
    const ns=schedule[nextIdx];
    nc.style.display='flex';
    document.getElementById('nextIcon').textContent=ns.i;
    document.getElementById('nextName').textContent=ns.a;
    document.getElementById('nextTime').innerHTML=`<span>Starts ${ns.t.split('-')[0]}</span><span class="nt-end">Ends ${ns.t.split('-')[1]||'-'}</span>`;
  } else nc.style.display='none';

  // Stats
  const streakStats=getStreakStats(data,N);
  const keys=streakStats.keys,last7=keys.slice(-7);
  const avgs=last7.map(kk=>(data[kk]?.done?.length||0)/N*100);
  const avg=avgs.length?Math.round(avgs.reduce((a,b)=>a+b,0)/avgs.length):null;
  const streak=streakStats.currentStreak;
  document.getElementById('mToday').textContent=pct+'%';
  document.getElementById('mStreak').textContent=streak;
  document.getElementById('mAvg').textContent=avg!==null?avg+'%':'-';
  renderInsightsGraph(data,N);
  renderExtendedInsights(data,N,done);
  const insRemainText=document.getElementById('insRemainText');
  const insRemainFill=document.getElementById('insRemainFill');
  const insStartText=document.getElementById('insStartText');
  const insEndText=document.getElementById('insEndText');
  if(ai>=0&&!done.includes(schedule[ai]?.id)){
    const s=schedule[ai];
    const total=Math.max(1,s.e-s.s);
    const now=nowMin();
    const rem=Math.max(0,s.e-nowMin());
    const elapsed=Math.max(0,Math.min(total,now-s.s));
    const elapsedPct=Math.round(elapsed*100/total);
    if(insStartText)insStartText.textContent=`Starts ${minsToTime(s.s)}`;
    if(insEndText)insEndText.textContent=`Ends ${minsToTime(s.e)}`;
    if(insRemainText)insRemainText.textContent=`${rem} min left`;
    if(insRemainFill)insRemainFill.style.width=elapsedPct+'%';
  }else{
    if(insStartText)insStartText.textContent='Starts --:--';
    if(insEndText)insEndText.textContent='Ends --:--';
    if(insRemainText)insRemainText.textContent='No active block';
    if(insRemainFill)insRemainFill.style.width='0%';
  }

  // Dots
  const dotsEl=document.getElementById('dotsEl');dotsEl.innerHTML='';
  for(let i=0;i<7;i++){
    const d=document.createElement('div');d.className='sdot';
    if(last7[i]&&(data[last7[i]]?.done?.length||0)>=Math.ceil(N*.7))d.classList.add('lit');
    dotsEl.appendChild(d);
  }
}

/*  SCHEDULE  */
function buildTimeline(){
  const tl=document.getElementById('tl');
  const data=normalizeAllData(),k=todayKey(),day=getDay(data,k);
  const done=day.done,notes=day.notes,ai=activeIdx();
  tl.innerHTML='';
  tl.classList.toggle('edit-mode',editMode);
  if(!schedule.length){
    const empty=document.createElement('div');
    empty.className='widget-card';
    empty.innerHTML=`<h3>No schedule yet</h3><p>Create your first block to start tracking.</p><div class="auth-row"><button class="btn-pill teal" onclick="addBlock()">Add First Block</button></div>`;
    tl.appendChild(empty);
    const summaryEl=document.getElementById('scheduleSummary');
    if(summaryEl)summaryEl.innerHTML='No blocks yet <span>Create your first block</span>';
    lastRenderedMinute=nowMin();
    return;
  }

  schedule.forEach((s,i)=>{
    const isDone=done.includes(s.id);
    const isActive=i===ai&&!isDone&&!editMode;
    const note=notes[s.id]||'';
    const hasNote=note.trim().length>0;
    const isOpen=openNotes[s.id]||false;

    const el=document.createElement('div');
    el.className='slot'+(isDone&&!editMode?' done':'')+(isActive?' active-now':'');
    el.classList.add('reveal');
    el.style.animationDelay=`${Math.min(i*20,180)}ms`;
    el.dataset.idx=i;

    el.innerHTML=`
      <div class="drag-grip" title="Drag to reorder">
        <span></span><span></span><span></span><span></span>
      </div>
      <div class="tc">
        <div class="tc-display">
          <div class="tc-icon">${s.i}</div>
          <div class="tc-time">${s.t.replace('-','-<br>')}</div>
        </div>
        <div class="time-inp-wrap">
          <div class="time-edit-ico">${s.i}</div>
          <div class="time-row">
            <input class="time-inp" type="time" value="${minsToTime(s.s)}" onchange="updateTime(${i},'s',this.value)">
            <span class="time-sep">-</span>
            <input class="time-inp" type="time" value="${minsToTime(s.e)}" onchange="updateTime(${i},'e',this.value)">
          </div>
        </div>
      </div>
      <div class="slot-content">
        <div class="act-row">
          <textarea class="editable act-inp" rows="1"
            ${editMode?'':'readonly'}
            oninput="autoResize(this);updateField(${i},'a',this.value)">${s.a}</textarea>
          <span class="now-badge">Now</span>
        </div>
        <textarea class="editable foc-inp" rows="1"
          ${editMode?'':'readonly'}
          oninput="autoResize(this);updateField(${i},'f',this.value)">${s.f}</textarea>
        <div class="note-area${isOpen?' open':''}" id="na-${s.id}">
          <textarea class="note-inp" rows="2" placeholder="Add a note..."
            onfocus="openNotes['${s.id}']=true"
            oninput="saveNote('${s.id}',this.value)">${note}</textarea>
        </div>
      </div>
      <div class="slot-ctrl">
        <button class="chk-btn" onclick="toggleDone('${s.id}')">OK</button>
        <button class="note-btn${hasNote?' has':''}" onclick="toggleNote('${s.id}')">N</button>
        <button class="del-btn" onclick="deleteBlock(${i})">X</button>
      </div>
    `;

    el.draggable=false;
    const grip=el.querySelector('.drag-grip');
    grip.addEventListener('mousedown',()=>{el.draggable=true;});
    grip.addEventListener('touchstart',()=>{el.draggable=true;},{passive:true});
    grip.addEventListener('mouseleave',()=>{if(!dragSrc)el.draggable=false;});
    el.addEventListener('dragstart',e=>{dragSrc=i;el.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
    el.addEventListener('dragend',()=>{el.draggable=false;el.classList.remove('dragging');dragSrc=null;tl.querySelectorAll('.slot').forEach(s2=>s2.classList.remove('drag-over'));});
    el.addEventListener('dragover',e=>{e.preventDefault();el.classList.add('drag-over');});
    el.addEventListener('dragleave',()=>el.classList.remove('drag-over'));
    el.addEventListener('drop',e=>{
      e.preventDefault();el.classList.remove('drag-over');
      if(dragSrc===null||dragSrc===i)return;
      const moved=schedule.splice(dragSrc,1)[0];
      schedule.splice(i,0,moved);
      dragSrc=null;saveSchedule();normalizeAllData();buildTimeline();
    });

    tl.appendChild(el);
    el.querySelectorAll('textarea').forEach(t=>autoResize(t));
  });

  const addInline=document.createElement('button');
  addInline.className='add-inline';
  addInline.style.display=editMode?'block':'none';
  addInline.innerHTML='+ &nbsp;Add New Block';
  addInline.onclick=addBlock;
  tl.appendChild(addInline);
  const summaryEl=document.getElementById('scheduleSummary');
  const doneCount=done.length;
  const activeText=(ai>=0&&!done.includes(schedule[ai]?.id))?`Now: ${schedule[ai].a}`:'Idle';
  if(summaryEl)summaryEl.innerHTML=`Done ${doneCount}/${schedule.length} <span>${activeText}</span>`;
  lastRenderedMinute=nowMin();
}

function autoResize(ta){ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';}

function toggleDone(id){
  const data=normalizeAllData(),k=todayKey(),day=getDay(data,k);
  const idx=day.done.indexOf(id);
  if(idx>=0){
    day.done.splice(idx,1);
    delete day.doneAt[id];
  }else{
    day.done.push(id);
    day.doneAt[id]=new Date().toISOString();
  }
  if(navigator.vibrate)navigator.vibrate(10);
  saveData(data);buildTimeline();updateHome();
}
function toggleNote(id){
  openNotes[id]=!openNotes[id];
  const na=document.getElementById('na-'+id);
  if(na){na.classList.toggle('open',openNotes[id]);if(openNotes[id])na.querySelector('textarea').focus();}
}
function saveNote(id,val){
  const data=normalizeAllData(),k=todayKey(),day=getDay(data,k);
  day.notes[id]=val;saveData(data);
}
function updateField(i,field,val){
  schedule[i][field]=val;
  if(field==='t'){
    const m=val.match(/(\d{1,2}):(\d{2})\s*[-]\s*(\d{1,2}):(\d{2})/);
    if(m){schedule[i].s=+m[1]*60+ +m[2];schedule[i].e=+m[3]*60+ +m[4];}
  }
  saveSchedule();
}
function updateTime(i,which,val){
  const mins=parseTime(val);
  if(mins===null)return;
  if(which==='s')schedule[i].s=mins;else schedule[i].e=mins;
  if(schedule[i].e<=schedule[i].s){
    if(which==='s')schedule[i].e=Math.min(1439,schedule[i].s+30);
    else schedule[i].s=Math.max(0,schedule[i].e-30);
    showToast('Adjusted to keep end after start');
  }
  schedule[i].t=`${minsToTime(schedule[i].s)}-${minsToTime(schedule[i].e)}`;
  saveSchedule();
  buildTimeline();
  updateHome();
  if(currentPage==='stats')renderStatsPage();
}
function deleteBlock(i){
  if(!confirm(`Remove "${schedule[i].a}"?`))return;
  schedule.splice(i,1);saveSchedule();normalizeAllData();buildTimeline();updateHome();if(currentPage==='stats')renderStatsPage();
  showToast('Block removed');
}
function addBlock(){
  schedule.push({id:'s'+(++idCtr),t:"09:00-10:00",a:"New Block",f:"Describe the focus of this block.",i:"N",s:540,e:600});
  saveSchedule();normalizeAllData();buildTimeline();
  showToast('New block added');
  setTimeout(()=>{const els=document.querySelectorAll('.slot');els[els.length-1]?.scrollIntoView({behavior:'smooth',block:'center'});},80);
}
function toggleEdit(){
  editMode=!editMode;
  const btn=document.getElementById('editBtn');
  btn.textContent=editMode?'Done':'Edit';
  btn.className='btn-pill'+(editMode?' gold':'');
  document.getElementById('addBtn').style.display=editMode?'inline-flex':'none';
  document.getElementById('resetSchedBtn').style.display=editMode?'inline-flex':'none';
  document.getElementById('toolbarLabel').textContent=editMode?'Edit Mode':'Blocks';
  document.getElementById('editHint').classList.toggle('on',editMode);
  showToast(editMode?'Edit mode on: choose times with pickers':'Edit mode saved');
  buildTimeline();
}
function resetDay(){
  if(!confirm('Reset today\'s progress?'))return;
  const data=normalizeAllData();data[todayKey()]={done:[],notes:{},doneAt:{}};saveData(data);
  openNotes={};buildTimeline();updateHome();
  showToast('Today reset');
}
function resetSchedule(){
  if(!confirm('Clear schedule and start fresh?'))return;
  schedule=JSON.parse(JSON.stringify(DEFAULT));saveSchedule();normalizeAllData();buildTimeline();updateHome();if(currentPage==='stats')renderStatsPage();
  showToast('Schedule cleared');
}
function exportLog(){
  const data=normalizeAllData(),k=todayKey(),day=getDay(data,k),N=schedule.length;
  let txt=`RESEARCHER'S LOG - ${k}\n${'-'.repeat(36)}\n\n`;
  schedule.forEach(s=>{
    txt+=(day.done.includes(s.id)?'[x]':'[ ]')+` [${s.t}] ${s.a}\n`;
    if(day.notes[s.id]?.trim())txt+=`   -> ${day.notes[s.id].trim()}\n`;
  });
  txt+=`\n${'-'.repeat(36)}\nDone: ${day.done.length}/${N} (${Math.round(day.done.length/(N||1)*100)}%)\n`;
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([txt],{type:'text/plain'}));
  a.download=`research-log-${k}.txt`;a.click();
  showToast('Log exported');
}

/*  STATS PAGE  */
function renderStatsPage(){
  const data=normalizeAllData(),k=todayKey(),day=getDay(data,k);
  const N=schedule.length||1,pct=Math.round(day.done.length/N*100);
  const streakStats=getStreakStats(data,N);
  const keys=streakStats.keys,last7=keys.slice(-7);
  const avgs=last7.map(kk=>(data[kk]?.done?.length||0)/N*100);
  const avg=avgs.length?Math.round(avgs.reduce((a,b)=>a+b,0)/avgs.length):null;
  const streak=streakStats.currentStreak;
  const best=streakStats.bestStreak;
  document.getElementById('st-today').textContent=pct+'%';
  document.getElementById('st-avg').textContent=avg!==null?avg+'%':'-';
  document.getElementById('st-streak').textContent=streak;
  document.getElementById('st-streak-sub').textContent=streak>=3?'On a roll!':streak>=1?'Keep going!':'Start today';
  document.getElementById('st-days').textContent=keys.length;
  document.getElementById('st-best').textContent=best;
  renderExtendedInsights(data,N,day.done||[]);

  // History
  const hl=document.getElementById('historyList');
  hl.innerHTML='';
  const recent=keys.slice(-14).reverse();
  if(!recent.length){hl.innerHTML='<p style="color:var(--txt3);font-size:13px;text-align:center;padding:20px">No history yet. Start checking off blocks!</p>';return;}
  recent.forEach(dk=>{
    const dp=(data[dk]?.done?.length||0)/N*100;
    const row=document.createElement('div');
    row.className='history-row';
    row.innerHTML=`
      <span class="history-date">${dk}</span>
      <div class="history-bar-wrap"><div class="history-bar-fill" style="width:${dp}%"></div></div>
      <span class="history-pct">${Math.round(dp)}%</span>
    `;
    hl.appendChild(row);
  });
}

/*  WIDGET DATA  */
function getWidgetData(){
  const data=normalizeAllData(),k=todayKey(),day=getDay(data,k);
  const N=schedule.length||1,done=day.done;
  const pct=Math.round(done.length/N*100);
  const ai=activeIdx();
  let active=null,next=null;
  if(ai>=0&&!done.includes(schedule[ai]?.id)){
    const s=schedule[ai];
    const rem=s.e-nowMin();
    active={name:s.a,icon:s.i,time:s.t,focus:s.f,
      time_left_min:rem,
      time_left:Math.floor(rem/60)>0?`${Math.floor(rem/60)}h ${rem%60}m`:`${rem} min`};
  }
  const m=nowMin();
  for(let i=(ai>=0?ai+1:0);i<schedule.length;i++){
    if(schedule[i].s>m&&!done.includes(schedule[i].id)){
      next={name:schedule[i].a,icon:schedule[i].i,time:schedule[i].t};break;
    }
  }
  return{
    active_name:active?active.name:'Free time',
    active_icon:active?active.icon:'-',
    active_focus:active?active.focus:'',
    time_left:active?active.time_left:'-',
    time_left_min:active?active.time_left_min:0,
    next_name:next?next.name:'No more blocks',
    next_icon:next?next.icon:'N',
    next_time:next?next.time.split('-')[0]:'',
    progress_pct:pct,
    progress_str:`${done.length}/${N}`,
    done_count:done.length,
    total_count:N,
    updated:new Date().toISOString()
  };
}
function updateWidgetPreview(){
  const d=getWidgetData();
  const el=document.getElementById('widgetDataPreview');
  if(el)el.textContent=JSON.stringify(d,null,2);
}
function showToast(msg){
  const t=document.getElementById('toast');
  if(!t)return;
  t.textContent=msg;
  t.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),1600);
}
function copyUrl(){
  const url=window.location.origin+window.location.pathname.replace('index.html','')+'widget-data.json';
  navigator.clipboard?.writeText(url).then(()=>showToast('URL copied')).catch(()=>showToast('Copy: '+url));
}

/*  INSTALL PWA  */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredPrompt=e;
  document.getElementById('install-banner').classList.add('show');
});
function installApp(){
  if(!deferredPrompt)return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(()=>{
    deferredPrompt=null;
    document.getElementById('install-banner').classList.remove('show');
  });
}
window.addEventListener('appinstalled',()=>{
  document.getElementById('install-banner').classList.remove('show');
});

/*  SERVICE WORKER  */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}

/*  TICK  */
function tick(){
  const now=new Date();
  const DS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const MS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const minuteStamp=now.getHours()*60+now.getMinutes();
  document.getElementById('dateEl').textContent=`${DS[now.getDay()]}, ${MS[now.getMonth()]} ${now.getDate()} ${now.getFullYear()}`;
  document.getElementById('clkEl').textContent=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  if(currentPage==='home')updateHome();
  if(currentPage==='schedule'&&minuteStamp!==lastRenderedMinute){
    buildTimeline();
    lastRenderedMinute=minuteStamp;
  }
}

normalizeAllData();
applyAppName();
buildTimeline();
lastRenderedMinute=nowMin();
tick();
setInterval(tick,1000);
if(!localUpdatedMs()&&hasMeaningfulLocalState()){
  localStorage.setItem(STATE_UPDATED_KEY,new Date().toISOString());
}
initSupabase();
renderAdvancedWidget();
refreshSnapshotPreview();
</script>
</body>
</html>

